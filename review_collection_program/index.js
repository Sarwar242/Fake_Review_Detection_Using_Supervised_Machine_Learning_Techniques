
const scrape = require('aliexpress-product-scraper');
const fs = require('fs');
const { stringify } = require("csv-stringify");
const e = require('express');
// const product = scrape('1005004533241376',1);

// product.then(res => {
//   let row=[];
//   row[0]=res['productId'].toString();
//   console.log(res['productId'].toString());
// });



// var products=[
//   '32640873627','1005004472692927','1005004271181900', '1005002605376165', '33034920439', '1005002027057999', '1005004271181900'
// ];241

// var products=[
//   '1005004658620189','1005001967152441','1005004861224480', '1005002996626019', '1005003038750934', '1005003469149446', '1005003626177028'
// ];242

// var products=[
//   '1005004271181900','1005001476962607','1005003991670583', '32953842067', '1005003838095382', '1005003786156381', '1005004132008365'
// ];243

// var products=[
//   '32976314078','1005003007664987','1005003500234210', '1005003249969288', '1005002286680672', '1005003716733109', '1005004604717203'
// ];244

var products=[
  '1005003252901171','1005003991670583','1005003825962440', '1005003917925627', '1005003309242553', '10000134738013', '1005001587385124'
];

// var products=[
//   '1005002509142292','1005002509142292','1005002509142292', '1005003991670583', '1005001967152441', '1005002509142292', '1005004658620189'
// ];

// var products=[
//   '1005003436350569','1005004036916386','1005002945567868', '1005002488780771', '1005004293914408', '1005003786156381', '1005003021369039'
// ];

// var products=[
//   '1005004200272688','1005003590622460','1005004069344436', '1005003745975514', '1005003119891945', '1005004266966327', '1005004532874074'
// ];

// var products=[
//   '1005001458726671','1005002342973082','1005004441554951', '1005003300147282', '1005004304085809', '4000331099431', '1005004702882561'
// ];

// var products=[
//   '32962876662','4000199010849','1005002997526765', '4001068167134', '4001068167134', '1005003767153565', '1005004137066899'
// ];

// var products=[
//   '1005004012011550','4000588272695','1005004373498063', '1005001775642292', '33036189155', '32957917214', '1005001587998700'
// ];

// var products=[
//   '1005002369191952','1005003597304068','4001193369663', '1005004320050979', '1005003933793132', '1005003332874374', '33012206693'
// ];

// var products=[
//   '33038202415','1005004704240157','1005004775980766', '1005003976078519', '1005001641043561', '1005004262782191', '1005003419274990'
// ];

// var products=[
//   '1005004064754062','1005003654777493','1005004704162090', '1005003099404098', '1005004547060260', '1005003670587218', '1005004704281632'
// ];

// var products=[
//   '1005004717449661','1005001581446623','1005002019200756', '1005004156346340', '1005004182450663', '1005004056629945', '1005004995935911'
// ];

// var products=[
//   '1005004707979311','1005004637848539','1005002363292769', '4000065009201', '1005004296132606', '1005003595898306', '1005003769691182'
// ];

// var products=[
//   '1005003723976142','32982825659','1005004562237002', '1005004722961460', '1005002928235404', '1005004717718522', '1005004295407168'
// ];

// var products=[
//   '1005003777441166','1005004683534541','32914220750', '33007657048', '4000181266647', '1005003659643076', '1005003636101993'
// ];


// var products=[
//   '1005004871006004','4000258688794','1005004713427482', '1005003908863803', '4000464142675', '4000311063460', '1005004699378507'
// ];



// var products=[
//   '1005004983875218','1005004649724020','1005004304546593', '1005004572497220', '32875135307', '1005003519872444', '1005005120599628'
// ];


// var products=[
//   '1005004717718522','1005004295407168','1005004707979311', '1005004637848539', '1005004296132606', '1005004422521326', '1005003595898306'
// ];


// var products=[
//   '1005004722961460','1005004562237002','1005004340470037', '1005004704531956', '1005004761755803', '1005004761755803', '1005004050915975'
// ];



// var products=[
//   '1005003769691182','1005004717449661','1005001581446623', '1005002019200756', '1005004156346340', '1005003468131028', '1005002928235404'
// ];



// var products=[
//   '1005003654777493','1005004064754062','1005004995935911', '1005004056629945', '1005004182450663', '1005004156346340', '1005002019200756'
// ];


// var products=[
//   '1005004704240157','33038202415','1005004704281632', '1005003670587218', '1005004547060260', '1005003099404098', '1005004704162090'
// ];


// var products=[
//   '1005003908863803','4000464142675','4000311063460', '1005004699378507', '1005003777441166', '1005004683534541', '32914220750'
// ];


// var products=[
//   '33007657048','4000181266647','1005003659643076', '1005003636101993', '1005003723976142', '32982825659', '1005004775980766'
// ];

// var products=[
//   '1005003519872444','1005005120599628','1005004422521326', '1005004871006004', '4000258688794', '1005004948579972', '1005004713427482'
// ];


// var products=[
//   '1005004174802622','1005004537354186','1005003650895314', '1005004340470037', '1005004704531956', '1005004761755803', '1005004050915975'
// ];

// var products=[
//   '1005003703394451','1005003336106312','4000384969041', '1005002011328923', '1005003012692903', '1005001948270637', '1005004078059890'
// ];

// var products=[
//   '1005003522327389','1005003777461386','1005004338375050', '4000630134094', '1005004609742109', '1005003599091628', '1005002993233474'
// ];


// var products=[
//   '4000085658139','1005003179130458','1005001572444537', '1005004789272273', '1005003706842759', '32969654905', '1005004736509310'
// ];



// var products=[
//   '1005004041980168','1005004546421283','1005001474709041', '1005002264229599', '1005004776212429', '1005003385751389', '1005004612976947'
// ];



// var products=[
//   '1005003484748607','1005001572049869','1005003240092166', '1005002747868448', '1005003293934563', '1005004526786912', '1005003782975983'
// ];



// var products=[
//   '1005005098923300','1005003908977328','1005004720477561', '1005004453470372', '1005004443238347', '1005004356299827', '1005003519089258'
// ];



// var products=[
//   '33031987122','1005003209618838','1005004735881879', '1005003767243361', '1005004683649080', '1005004750784765', '1005004375956066'
// ];




// var products=[
//   '1005003767243361','1005004735881879','1005003209618838', '33031987122', '1005004829135918', '1005004220989061', '32979480264'
// ];




// var products=[
//   '1005004453470372','1005004750784765','1005004375956066', '1005005098923300', '1005003908977328', '1005004720477561', '1005004683649080'
// ];



// var products=[
//   '1005003362039043','1005004543506653','1005001403368420', '1005004316822977', '1005004407182499', '1005004231211153', '1005004768030507'
// ];




// var products=[
//   '1005003435922256','1005004392996828','1005004916711123', '1005004728625694', '1005004161612654', '1005004707504133', '1005004715613934'
// ];



// var products=[
//   '1005004295128131','1005002650745096','1005004322977380', '1005003460466833', '1005004311657581', '1005004005613020', '1005002957664111'
// ];



// var products=[
//   '1005003773437408','4001094948882','1005004712982420', '1005004702637619', '1005003162252850', '1005003353891034', '1005004666569156'
// ];



// var products=[
//   '1005002022154585','1005004203264011','1005003773437408', '4001244405354', '1005003519089258', '1005004356299827', '1005004443238347'
// ];




// var products=[
//   '1005002032914741','4000681184751','1005002986388499', '1005004776266827', '1005003170030678', '1005004311490697', '1005001994719607'
// ];




// var products=[
//   '1005001836295233','1005002971608822','1005004281258349', '1005004171357705', '1005004471498419', '1005004279790157', '1005004309160898'
// ];




// var products=[
//   '1005005087089275','1005004871665341','1005004927372104', '1005003651568093', '4001003899633', '1005004787465965', '1005004328916148'
// ];




// var products=[
//   '1005004988979737','1005004891064939','1005004222139470', '1005004078747793', '4000065009201', '1005003247396625', '1005004702637619'
// ];




// var products=[
//   '1005003162965715','1005004356204441','1005003649292678', '1005001949339419', '1005004343764591', '4001259889434', '1005004374907477'
// ];




// var products=[
//   '1005004894029808','1005004431634004','1005004288010206', '1005003991599804', '1005004280836400', '4000322518312', '1005003247476174'
// ];


// var products=[
//   '1005001814427611','1005002689133140','1005004848511178', '1005001642517970', '1005004251407021', '1005003698874692', '1005004449012911'
// ];

// var products=[
//   '1005004097331608','33023381155','1005003546514968', '4000080546837', '1005004629764470', '1005003679361822', '1005003689766216'
// ];





let columns = [
  "productId",
  "author",
  "country",
  "rating",
  "content",
  "date"
];
process.setMaxListeners(0);
let filename = "saved_from_Ali-242.csv";


// productsArr.forEach(products => {
//   console.log(products);
try {
  let i=61;
  while (fs.existsSync(filename)) {
    i++;
    if(filename === "saved_from_Ali.csv")
      filename= "saved_from_Ali-1.csv";
    else
      filename= filename.replace("-"+(i-1)+".csv", "-"+i+".csv");
    // console.log(filename)
  }
} catch(err) {
  console.error(err);
}
console.log(filename);
let writableStream = fs.createWriteStream(filename);

let j=0;
let stringifier =  stringify({ header: true, columns: columns });
 for (let key in products) {
  
  let product = scrape(products[key],500);
  aliReviews(product);
}
stringifier.pipe(writableStream);


// });

async function aliReviews(product) {
  await new Promise(r => setTimeout(r, 1000));
  await product.then(res => {
    let row=[];
    row[0]=res['productId'].toString();
    console.log(res['productId'].toString());
    res['feedback'].forEach(element => {
      if(element['content'] !== ''){ 
        row[1]=element['displayName'];
        row[2]=element['country'];
        row[3]=element['rating'];
        row[4]=element['content'].replace(/(\r\n|\n|\r)/gm, " ");
        row[5]=element['date'].toJSON().slice(0, 10).toString();
        stringifier.write(row);
       
      } 
      
  }); 
  showDownloadingProgress(++j, products.length);
});
}
function showDownloadingProgress(received, total) {
  var percentage = ((received * 100) / total).toFixed(2);
  console.log(percentage + "% | Collected reviews of no. " + received + " product out of " + total + " products.");
}